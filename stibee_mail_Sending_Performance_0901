import os
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from dotenv import load_dotenv
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import re
import requests
import pickle
from datetime import datetime, timedelta
from selenium.webdriver.chrome.options import Options

# 1. í™˜ê²½ë³€ìˆ˜(.env)ì—ì„œ Stibee ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
print("í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì¤‘...")
load_dotenv('C:/Users/7040_64bit/Desktop/20250708.env')

STIBEE_EMAIL = os.getenv('STIBEE_EMAIL')
STIBEE_PASSWORD = os.getenv('STIBEE_PASSWORD')
STIBEE_API_KEY = os.getenv('STIBEE_API_KEY')  # API í‚¤ ì¶”ê°€

print("í™˜ê²½ë³€ìˆ˜ ë¡œë“œ í™•ì¸:")
print(f"ì´ë©”ì¼: {STIBEE_EMAIL}")
print(f"ë¹„ë°€ë²ˆí˜¸: {'*' * len(STIBEE_PASSWORD) if STIBEE_PASSWORD else 'None'}")
print(f"API í‚¤: {'ìˆìŒ' if STIBEE_API_KEY else 'ì—†ìŒ'}")

# ë¡œê·¸ì¸ ì •ë³´ ìœ íš¨ì„± ê²€ì‚¬
if not STIBEE_EMAIL or not STIBEE_PASSWORD:
    print("âŒ ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    print("âŒ .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    exit(1)

if '@' not in STIBEE_EMAIL:
    print("âŒ ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
    exit(1)

print("âœ… ë¡œê·¸ì¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ")

# 2. êµ¬ê¸€ ì‹œíŠ¸ ì¸ì¦
print("ğŸ” êµ¬ê¸€ì‹œíŠ¸ ì¸ì¦ ì¤‘...")

# ì¸ì¦ íŒŒì¼ ê²½ë¡œ í™•ì¸
json_path = 'C:/Users/7040_64bit/Desktop/python/single-arcadia-436209-g2-ebfcbea8518b.json'
if not os.path.exists(json_path):
    print(f"âŒ êµ¬ê¸€ì‹œíŠ¸ ì¸ì¦ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {json_path}")
    print("âŒ ì¸ì¦ íŒŒì¼ì´ ì˜¬ë°”ë¥¸ ê²½ë¡œì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    exit(1)

print(f"âœ… ì¸ì¦ íŒŒì¼ ë°œê²¬: {json_path}")

# ì¸ì¦ íŒŒì¼ ë‚´ìš© í™•ì¸
try:
    with open(json_path, 'r', encoding='utf-8') as f:
        json_content = f.read()
        print(f"ğŸ“„ ì¸ì¦ íŒŒì¼ í¬ê¸°: {len(json_content)} bytes")
        if len(json_content) < 100:
            print("âŒ ì¸ì¦ íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            exit(1)
        print("âœ… ì¸ì¦ íŒŒì¼ ë‚´ìš© í™•ì¸ ì™„ë£Œ")
except Exception as e:
    print(f"âŒ ì¸ì¦ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {e}")
    exit(1)

# ì‹œíŠ¸ URL ì„¤ì •
sheet_url = 'https://docs.google.com/spreadsheets/d/1kAO3oRGPuLSEPx_4nYuSYiUf0m3xdbqtI1hR42WNfjU/edit?gid=0'
print(f"ğŸ“„ êµ¬ê¸€ì‹œíŠ¸ URL: {sheet_url}")

# ì¸ì¦ ë²”ìœ„ ì„¤ì •
scope = [
    'https://spreadsheets.google.com/feeds',
    'https://www.googleapis.com/auth/drive',
    'https://www.googleapis.com/auth/spreadsheets'
]

print(f"ğŸ”‘ ì¸ì¦ ë²”ìœ„: {scope}")

try:
    print("ğŸ” ServiceAccountCredentials ìƒì„± ì¤‘...")
    creds = ServiceAccountCredentials.from_json_keyfile_name(json_path, scope)
    print("âœ… ServiceAccountCredentials ìƒì„± ì„±ê³µ")
    
    print("ğŸ” gspread í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ ì¤‘...")
    client = gspread.authorize(creds)
    print("âœ… gspread í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ ì„±ê³µ!")
    
    # ì¸ì¦ëœ í´ë¼ì´ì–¸íŠ¸ ì •ë³´ í™•ì¸
    print(f"ğŸ”‘ ì¸ì¦ëœ í´ë¼ì´ì–¸íŠ¸: {type(client)}")
    
    # ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
    try:
        print("ğŸ” êµ¬ê¸€ì‹œíŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...")
        test_spreadsheet = client.open_by_url(sheet_url)
        print(f"âœ… êµ¬ê¸€ì‹œíŠ¸ ì—°ê²° ì„±ê³µ: {test_spreadsheet.title}")
        
        # ì›Œí¬ì‹œíŠ¸ ëª©ë¡ í™•ì¸
        worksheets = test_spreadsheet.worksheets()
        print(f"ğŸ“‹ ì›Œí¬ì‹œíŠ¸ ëª©ë¡: {[ws.title for ws in worksheets]}")
        
        # 'ë©”ì¼ ë°œì†¡ ì„±ê³¼' ì›Œí¬ì‹œíŠ¸ ì¡´ì¬ í™•ì¸
        target_worksheet = None
        for ws in worksheets:
            if ws.title == 'ë©”ì¼ ë°œì†¡ ì„±ê³¼':
                target_worksheet = ws
                break
        
        if target_worksheet:
            print(f"âœ… 'ë©”ì¼ ë°œì†¡ ì„±ê³¼' ì›Œí¬ì‹œíŠ¸ ë°œê²¬")
            # ì›Œí¬ì‹œíŠ¸ ì •ë³´ í™•ì¸
            print(f"ğŸ“Š ì›Œí¬ì‹œíŠ¸ í¬ê¸°: {target_worksheet.row_count}í–‰ x {target_worksheet.col_count}ì—´")
        else:
            print(f"âŒ 'ë©”ì¼ ë°œì†¡ ì„±ê³¼' ì›Œí¬ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
            print(f"ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬ì‹œíŠ¸: {[ws.title for ws in worksheets]}")
            print(f"ğŸ’¡ ì •í™•í•œ ì›Œí¬ì‹œíŠ¸ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”")
        
    except Exception as e:
        print(f"âŒ êµ¬ê¸€ì‹œíŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        print(f"ğŸ’¡ ì‹œíŠ¸ URLì´ë‚˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”")
        
except Exception as e:
    print(f"âŒ êµ¬ê¸€ì‹œíŠ¸ ì¸ì¦ ì‹¤íŒ¨: {e}")
    print("âŒ ì¸ì¦ íŒŒì¼ì˜ ë‚´ìš©ì´ë‚˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    print("âŒ êµ¬ê¸€ í´ë¼ìš°ë“œ í”„ë¡œì íŠ¸ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì •ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    import traceback
    traceback.print_exc()
    exit(1)

# 3. Selenium ë“œë¼ì´ë²„ ì„¤ì •
chrome_options = Options()
chrome_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36")
service = Service(r'C:/Users/7040_64bit/Desktop/python/chromedriver.exe')
driver = webdriver.Chrome(service=service, options=chrome_options)

def stibee_login():
    """ìŠ¤í‹°ë¹„ ë¡œê·¸ì¸ í•¨ìˆ˜"""
    print("ìŠ¤í‹°ë¹„ ë¡œê·¸ì¸ ì¤‘...")
    
    try:
        # ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        driver.get('https://stibee.com/login')
        time.sleep(5)
        
        print(f"í˜„ì¬ URL: {driver.current_url}")
        
        # ì´ë©”ì¼ ì…ë ¥ë€ ì°¾ê¸° (ì—¬ëŸ¬ XPATH íŒ¨í„´ ì‹œë„)
        email_input = None
        email_patterns = [
            '//*[@id="login-form"]/fieldset[1]/div[1]/div/div[2]/div/div/div/input',
            '//input[@type="email"]',
            '//input[@name="email"]',
            '//input[contains(@placeholder, "ì´ë©”ì¼")]',
            '//input[contains(@placeholder, "email")]',
            '//input[contains(@class, "email")]'
        ]
        
        for pattern in email_patterns:
            try:
                email_input = driver.find_element(By.XPATH, pattern)
                print(f"ì´ë©”ì¼ ì…ë ¥ë€ ë°œê²¬: {pattern}")
                break
            except:
                continue
        
        if not email_input:
            print("âŒ ì´ë©”ì¼ ì…ë ¥ë€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            # í˜ì´ì§€ ì†ŒìŠ¤ ì €ì¥í•˜ì—¬ ë””ë²„ê¹…
            with open('login_page.html', 'w', encoding='utf-8') as f:
                f.write(driver.page_source)
            print("ë¡œê·¸ì¸ í˜ì´ì§€ HTMLì„ login_page.htmlë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")
            return False
        
        # ì´ë©”ì¼ ì…ë ¥
        email_input.clear()
        email_input.send_keys(STIBEE_EMAIL)
        print("ì´ë©”ì¼ ì…ë ¥ ì™„ë£Œ")
        time.sleep(1)
        
        # ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€ ì°¾ê¸° (ì—¬ëŸ¬ XPATH íŒ¨í„´ ì‹œë„)
        password_input = None
        password_patterns = [
            '//*[@id="login-form"]/fieldset[1]/div[2]/div/div[2]/div/div/div/div/input',
            '//input[@type="password"]',
            '//input[@name="password"]',
            '//input[contains(@placeholder, "ë¹„ë°€ë²ˆí˜¸")]',
            '//input[contains(@placeholder, "password")]',
            '//input[contains(@class, "password")]'
        ]
        
        for pattern in password_patterns:
            try:
                password_input = driver.find_element(By.XPATH, pattern)
                print(f"ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€ ë°œê²¬: {pattern}")
                break
            except:
                continue
        
        if not password_input:
            print("âŒ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ë€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return False
        
        # ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
        password_input.clear()
        password_input.send_keys(STIBEE_PASSWORD)
        print("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ")
        time.sleep(1)
        
        # ë¡œê·¸ì¸ ë²„íŠ¼ ì°¾ê¸° (ì—¬ëŸ¬ XPATH íŒ¨í„´ ì‹œë„)
        login_button = None
        login_patterns = [
            '//*[@id="login-form"]/div/button',
            '//button[@type="submit"]',
            '//button[contains(text(), "ë¡œê·¸ì¸")]',
            '//button[contains(text(), "Login")]',
            '//input[@type="submit"]',
            '//button[contains(@class, "login")]',
            '//button[contains(@class, "submit")]'
        ]
        
        for pattern in login_patterns:
            try:
                login_button = driver.find_element(By.XPATH, pattern)
                print(f"ë¡œê·¸ì¸ ë²„íŠ¼ ë°œê²¬: {pattern}")
                break
            except:
                continue
        
        if not login_button:
            print("âŒ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return False
        
        # ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
        login_button.click()
        print("ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­")
        
        # ë¡œê·¸ì¸ í›„ ëŒ€ê¸° ë° í™•ì¸
        time.sleep(8)
        print(f"ë¡œê·¸ì¸ í›„ í˜„ì¬ URL: {driver.current_url}")
        
        # ë¡œê·¸ì¸ ì„±ê³µ ì—¬ë¶€ í™•ì¸
        if 'login' in driver.current_url.lower():
            print("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ì—¬ì „íˆ ë¡œê·¸ì¸ í˜ì´ì§€ì— ìˆìŒ")
            return False
        
        # ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ ì‹œë„
        try:
            driver.get('https://stibee.com/dashboard')
            time.sleep(5)
            print(f"ëŒ€ì‹œë³´ë“œ ì´ë™ í›„ í˜„ì¬ URL: {driver.current_url}")
            
            if 'login' in driver.current_url.lower():
                print("âŒ ì„¸ì…˜ ë§Œë£Œë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ë¨")
                return False
                
        except Exception as e:
            print(f"ëŒ€ì‹œë³´ë“œ ì´ë™ ì‹¤íŒ¨: {e}")
            return False
        
        # ë°œì†¡ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™ ì‹œë„
        try:
            driver.get('https://stibee.com/emails/1?emailStatus=3')
            time.sleep(5)
            print(f"ë°œì†¡ì™„ë£Œ í˜ì´ì§€ ì§„ì… í›„ URL: {driver.current_url}")
            
            if 'login' in driver.current_url.lower():
                print("âŒ ì„¸ì…˜ ë§Œë£Œë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ë¨")
                return False
                
        except Exception as e:
            print(f"ë°œì†¡ì™„ë£Œ í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨: {e}")
            return False
        
        print("âœ… ë¡œê·¸ì¸ ì„±ê³µ!")
        return True
        
    except Exception as e:
        print(f"âŒ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return False

def get_email_list_from_website():
    """ìŠ¤í‹°ë¹„ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ì´ë©”ì¼ ëª©ë¡ ìŠ¤í¬ë˜í•‘"""
    print("ì´ë©”ì¼ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...")
    driver.get('https://stibee.com/emails')
    time.sleep(5)
    
    # í˜„ì¬ URL í™•ì¸
    current_url = driver.current_url
    print(f"í˜„ì¬ URL: {current_url}")
    
    # ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if 'login' in current_url:
        print("âŒ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")
        return []
    
    # ë””ë²„ê¹…ìš©: í˜ì´ì§€ HTML ì €ì¥
    print("íŒŒì¼ ì €ì¥ ì‹œë„: stibee_emails_page.html")
    try:
        with open('stibee_emails_page.html', 'w', encoding='utf-8') as f:
            f.write(driver.page_source)
        print("ì´ë©”ì¼ ëª©ë¡ í˜ì´ì§€ HTMLì„ stibee_emails_page.htmlë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: {e}")
    
    emails = []
    try:
        # í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        print("ì´ë©”ì¼ ëª©ë¡ í…Œì´ë¸” ë¡œë”© ëŒ€ê¸° ì¤‘...")
        time.sleep(3)
        
        # ë‹¤ì–‘í•œ XPATH ì‹œë„
        xpath_patterns = [
            '//table/tbody/tr',
            '//div[contains(@class, "email-list")]//tr',
            '//div[contains(@class, "table")]//tr',
            '//tbody/tr',
            '//tr[contains(@class, "email-row")]'
        ]
        
        rows = []
        for pattern in xpath_patterns:
            try:
                rows = driver.find_elements(By.XPATH, pattern)
                if rows:
                    print(f"XPATH íŒ¨í„´ '{pattern}'ìœ¼ë¡œ {len(rows)}ê°œ í–‰ ë°œê²¬")
                    break
            except Exception as e:
                print(f"XPATH íŒ¨í„´ '{pattern}' ì‹¤íŒ¨: {e}")
                continue
        
        print(f"ë°œê²¬ëœ ì´ë©”ì¼ ìˆ˜: {len(rows)}")
        
        if not rows:
            print("ì´ë©”ì¼ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
            return []
        
        for i, row in enumerate(rows[:5]):  # ìµœëŒ€ 5ê°œë§Œ ì²˜ë¦¬
            try:
                # ë‹¤ì–‘í•œ ë§í¬ ì¶”ì¶œ ë°©ë²• ì‹œë„
                link_selectors = [
                    './/td[1]//a',
                    './/a[contains(@href, "/email/")]',
                    './/a',
                    './/td//a'
                ]
                
                title_element = None
                for selector in link_selectors:
                    try:
                        title_element = row.find_element(By.XPATH, selector)
                        break
                    except:
                        continue
                
                if title_element:
                    title = title_element.text.strip()
                    href = title_element.get_attribute('href')
                    
                    # ì´ë©”ì¼ ID ì¶”ì¶œ (URLì—ì„œ)
                    email_id_match = re.search(r'/email/(\d+)', href)
                    email_id = email_id_match.group(1) if email_id_match else None
                    
                    if email_id and title:
                        emails.append({
                            'id': email_id,
                            'subject': title,
                            'url': href
                        })
                        print(f"ì´ë©”ì¼ ë°œê²¬: ID={email_id}, ì œëª©={title}")
                
            except Exception as e:
                print(f"í–‰ {i+1} ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
                continue
                
    except Exception as e:
        print(f"ì´ë©”ì¼ ëª©ë¡ ìŠ¤í¬ë˜í•‘ ì˜¤ë¥˜: {e}")
    
    return emails

def get_email_list_from_api():
    """ìŠ¤í‹°ë¹„ APIë¡œ ìµœê·¼ ì´ë©”ì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    if not STIBEE_API_KEY or STIBEE_API_KEY == 'your_api_key_here':
        print("API í‚¤ê°€ ì—†ê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì•„ì„œ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìŠ¤í¬ë˜í•‘í•©ë‹ˆë‹¤.")
        return get_email_list_from_website()
    
    # ìŠ¤í‹°ë¹„ API ë¬¸ì„œì— ë”°ë¥¸ ì •í™•í•œ ì—”ë“œí¬ì¸íŠ¸ (v2)
    api_url = 'https://api.stibee.com/v2/emails'
    headers = {
        'AccessToken': STIBEE_API_KEY,
        'Content-Type': 'application/json'
    }
    
    # API íŒŒë¼ë¯¸í„° (ì „ì²´ ì´ë©”ì¼ ê°€ì ¸ì˜¤ê¸°)
    params = {
        'limit': 1000,  # ì¶©ë¶„íˆ í° ê°’ìœ¼ë¡œ ì„¤ì •
        'offset': 0
    }
    
    try:
        print(f"API ìš”ì²­: {api_url}")
        print(f"í—¤ë”: AccessToken={STIBEE_API_KEY[:10]}...")
        print(f"íŒŒë¼ë¯¸í„°: {params}")
        
        response = requests.get(api_url, headers=headers, params=params)
        print(f"ì‘ë‹µ ìƒíƒœ ì½”ë“œ: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            print(f"ì‘ë‹µ ë°ì´í„° êµ¬ì¡°: {list(data.keys()) if isinstance(data, dict) else 'Not a dict'}")
            
            # API ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ì´ë©”ì¼ ëª©ë¡ ì¶”ì¶œ
            if 'items' in data:
                emails = data['items']
                print(f"ì´ ì´ë©”ì¼ ìˆ˜: {data.get('total', 0)}")
            elif 'data' in data:
                emails = data['data']
            elif isinstance(data, list):
                emails = data
            else:
                print(f"ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ êµ¬ì¡°: {data}")
                return []
            
            # ìµœê·¼ ìˆœìœ¼ë¡œ ì •ë ¬ (created_at ê¸°ì¤€)
            if emails and 'created_at' in emails[0]:
                emails.sort(key=lambda x: x.get('created_at', ''), reverse=True)
            
            print(f"APIì—ì„œ {len(emails)}ê°œì˜ ì´ë©”ì¼ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
            for email in emails[:5]:  # ì²˜ìŒ 5ê°œë§Œ ì¶œë ¥
                print(f"  - ID: {email.get('id')}, ì œëª©: {email.get('subject', 'N/A')}")
            return emails
        else:
            print(f"API ì˜¤ë¥˜: {response.status_code}")
            print(f"ì˜¤ë¥˜ ë‚´ìš©: {response.text}")
            
            # ê¶Œí•œ ê´€ë ¨ ì˜¤ë¥˜ì¸ì§€ í™•ì¸
            if response.status_code == 403:
                print("âŒ ê¶Œí•œ ì˜¤ë¥˜: í”„ë¡œ ë˜ëŠ” ì—”í„°í”„ë¼ì´ì¦ˆ ìš”ê¸ˆì œê°€ í•„ìš”í•©ë‹ˆë‹¤.")
            elif response.status_code == 401:
                print("âŒ ì¸ì¦ ì˜¤ë¥˜: API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            print("ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìŠ¤í¬ë˜í•‘ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.")
            return get_email_list_from_website()
    except Exception as e:
        print(f"API ìš”ì²­ ì˜¤ë¥˜: {e}")
        print("ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìŠ¤í¬ë˜í•‘ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.")
        return get_email_list_from_website()

def ensure_logged_in():
    # ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³ , í•„ìš”ì‹œ ì¬ë¡œê·¸ì¸
    if 'login' in driver.current_url:
        print("ì„¸ì…˜ ë§Œë£Œ, ì¬ë¡œê·¸ì¸ ì‹œë„")
        stibee_login()

def get_existing_email_ids():
    """êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ê¸°ì¡´ì— ê¸°ë¡ëœ ì´ë©”ì¼ ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
    try:
        sheet1 = client.open_by_url(sheet_url).worksheet('ë©”ì¼ ë°œì†¡ ì„±ê³¼')
        existing_data = sheet1.get_all_values()
        
        if len(existing_data) <= 1:  # í—¤ë”ë§Œ ìˆëŠ” ê²½ìš°
            return set()
        
        # ì²« ë²ˆì§¸ ì—´(ì´ë©”ì¼ ID)ë§Œ ì¶”ì¶œ
        existing_ids = set()
        for row in existing_data[1:]:  # í—¤ë” ì œì™¸
            if row[0] and row[0].strip():  # ë¹ˆ ê°’ì´ ì•„ë‹Œ ê²½ìš°
                existing_ids.add(row[0].strip())
        
        print(f"ğŸ“Š ê¸°ì¡´ ì´ë©”ì¼ ID ìˆ˜: {len(existing_ids)}")
        return existing_ids
        
    except Exception as e:
        print(f"âŒ ê¸°ì¡´ ì´ë©”ì¼ ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
        return set()

def update_google_sheet_sheet1_append(email_id, stats):
    """ë©”ì¼ ë°œì†¡ ì„±ê³¼ ì‹œíŠ¸ì— ë°ì´í„° ì¶”ê°€"""
    try:
        print(f"ğŸ“ êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œë„ ì¤‘...")
        print(f"   ì´ë©”ì¼ ID: {email_id}")
        print(f"   í†µê³„ ë°ì´í„°: {stats}")
        
        # í†µê³„ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if not stats:
            print("   âŒ í†µê³„ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ")
            return False
        
        if not isinstance(stats, dict):
            print(f"   âŒ í†µê³„ ë°ì´í„°ê°€ ë”•ì…”ë„ˆë¦¬ê°€ ì•„ë‹˜: {type(stats)}")
            return False
        
        # í•„ìˆ˜ í•„ë“œ í™•ì¸
        required_fields = ['ë©”ì¼ì œëª©', 'ë°œì†¡ì¼ì', 'ë°œì†¡ì„±ê³µìˆ˜', 'ì˜¤í”ˆìˆ˜', 'í´ë¦­ìˆ˜', 'ìˆ˜ì‹ ê±°ë¶€ìˆ˜']
        missing_fields = []
        for field in required_fields:
            if field not in stats or not stats[field]:
                missing_fields.append(field)
        
        if missing_fields:
            print(f"   âŒ ëˆ„ë½ëœ í•„ë“œ: {missing_fields}")
            print(f"   ğŸ“Š í˜„ì¬ í†µê³„ ë°ì´í„°: {stats}")
            return False
        
        # êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
        try:
            print(f"   ğŸ” êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ ì‹œë„...")
            sheet1 = client.open_by_url(sheet_url).worksheet('ë©”ì¼ ë°œì†¡ ì„±ê³¼')
            print(f"   âœ… êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ ì„±ê³µ")
        except Exception as e:
            print(f"   âŒ êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ ì‹¤íŒ¨: {e}")
            print(f"   ğŸ’¡ ì‹œíŠ¸ëª… 'ë©”ì¼ ë°œì†¡ ì„±ê³¼'ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”")
            import traceback
            traceback.print_exc()
            return False
        
        # ì¤‘ë³µ ì²´í¬ (ì´ë©”ì¼ ID ê¸°ì¤€)
        try:
            print(f"   ğŸ” ì¤‘ë³µ ì²´í¬ ì¤‘...")
            existing_data = sheet1.get_all_values()
            print(f"   ğŸ“Š ê¸°ì¡´ ë°ì´í„° í–‰ ìˆ˜: {len(existing_data)}")
            
            if len(existing_data) > 1:  # í—¤ë”ê°€ ìˆëŠ” ê²½ìš°
                existing_ids = [row[0] for row in existing_data[1:] if row[0].strip()]
                print(f"   ğŸ“‹ ê¸°ì¡´ ì´ë©”ì¼ ID ëª©ë¡: {existing_ids[:5]}...")  # ì²˜ìŒ 5ê°œë§Œ í‘œì‹œ
                
                if email_id in existing_ids:
                    print(f"   â­ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ ID: {email_id}")
                    return True  # ì¤‘ë³µì´ì§€ë§Œ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                else:
                    print(f"   âœ… ìƒˆë¡œìš´ ì´ë©”ì¼ ID: {email_id}")
            else:
                print(f"   âš ï¸ í—¤ë”ë§Œ ì¡´ì¬ (ë°ì´í„° ì—†ìŒ)")
                
        except Exception as e:
            print(f"   âš ï¸ ì¤‘ë³µ ì²´í¬ ì‹¤íŒ¨: {e}")
            import traceback
            traceback.print_exc()
        
        # ë°ì´í„° ì „ì²˜ë¦¬ ë° ê²€ì¦
        try:
            # ë°œì†¡ì¼ì í˜•ì‹ ì •ë¦¬ (ì›ë³¸ í˜•ì‹ ìœ ì§€)
            sent_date = stats.get('ë°œì†¡ì¼ì', '')
            if sent_date:
                print(f"   ğŸ” ì›ë³¸ ë°œì†¡ì¼ì: {sent_date}")
                
                # ì›ë³¸ í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë³€í™˜í•˜ì§€ ì•ŠìŒ)
                print(f"   ğŸ“… ì›ë³¸ í˜•ì‹ ìœ ì§€: {sent_date}")
                
                # ë‹¨, ë¶ˆì™„ì „í•œ í˜•ì‹ (2025.)ë§Œ ì²˜ë¦¬
                if sent_date.endswith('.') and len(sent_date) <= 5:
                    print(f"   âš ï¸ ë¶ˆì™„ì „í•œ ë‚ ì§œ í˜•ì‹: {sent_date}")
                    # í˜„ì¬ ë‚ ì§œë¡œ ëŒ€ì²´
                    from datetime import datetime
                    current_date = datetime.now()
                    sent_date = f"{current_date.year}. {current_date.month}. {current_date.day}. ì˜¤ì „ 12:00"
                    print(f"   ğŸ“… í˜„ì¬ ë‚ ì§œë¡œ ëŒ€ì²´: {sent_date}")
            
            # ìˆ«ì ë°ì´í„° ì •ë¦¬ (ì‰¼í‘œ ì œê±°, ìˆ«ìë§Œ ì¶”ì¶œ)
            def clean_number(value):
                if not value:
                    return '0'
                # ì‰¼í‘œ ì œê±°í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
                cleaned = str(value).replace(',', '').replace(' ', '')
                if cleaned.isdigit():
                    return cleaned
                return '0'
            
            # í¼ì„¼íŠ¸ ë°ì´í„° ì •ë¦¬
            def clean_percentage(value):
                if not value:
                    return '0%'
                # % ê¸°í˜¸ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ ì¶”ê°€
                if '%' in str(value):
                    return str(value)
                return f"{value}%"
            
            # êµ¬ê¸€ì‹œíŠ¸ì˜ ì‹¤ì œ ì—´ êµ¬ì¡°ì— ë§ì¶° ë°ì´í„° êµ¬ì„±
            new_row = [
                str(email_id),                                    # Aì—´: ì´ë©”ì¼ID
                sent_date,                                        # Bì—´: ë°œì†¡ì¼ì
                str(stats.get('ë©”ì¼ì œëª©', '')),                   # Cì—´: ë©”ì¼ ì œëª©
                clean_number(stats.get('ë°œì†¡ì„±ê³µìˆ˜', '0')),        # Dì—´: ë°œì†¡ì„±ê³µìˆ˜
                clean_percentage(stats.get('ë°œì†¡ì„±ê³µìœ¨', '0%')),   # Eì—´: ë°œì†¡ì„±ê³µìœ¨
                clean_number(stats.get('ì˜¤í”ˆìˆ˜', '0')),           # Fì—´: ì˜¤í”ˆìˆ˜
                clean_percentage(stats.get('ì˜¤í”ˆìœ¨', '0%')),      # Gì—´: ì˜¤í”ˆìœ¨
                clean_number(stats.get('í´ë¦­ìˆ˜', '0')),           # Hì—´: í´ë¦­ìˆ˜
                clean_percentage(stats.get('í´ë¦­ë¥ ', '0%')),      # Iì—´: í´ë¦­ë¥ 
                clean_number(stats.get('ìˆ˜ì‹ ê±°ë¶€ìˆ˜', '0'))         # Jì—´: ìˆ˜ì‹ ê±°ë¶€ìˆ˜
            ]
            
            print(f"ğŸ“Š ì…ë ¥í•  ë°ì´í„°: {new_row}")
            
            # ë°ì´í„° ìœ íš¨ì„± ìµœì¢… ê²€ì‚¬
            if not email_id or str(email_id).strip() == '':
                print("   âŒ ì´ë©”ì¼ IDê°€ ë¹„ì–´ìˆìŒ")
                return False
                
            if not stats.get('ë©”ì¼ì œëª©') or str(stats.get('ë©”ì¼ì œëª©', '')).strip() == '':
                print("   âŒ ë©”ì¼ ì œëª©ì´ ë¹„ì–´ìˆìŒ")
                return False
            
            # ë¹ˆ ì…€ ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
            for i, value in enumerate(new_row):
                if not value or str(value).strip() == '':
                    print(f"   âŒ {i+1}ë²ˆì§¸ ì—´ì˜ ê°’ì´ ë¹„ì–´ìˆìŒ: {value}")
                    new_row[i] = '0' if i in [3, 5, 7, 9] else 'N/A'  # ìˆ«ì ì—´ì€ 0, í…ìŠ¤íŠ¸ ì—´ì€ N/A
            
            print(f"ğŸ“Š ìµœì¢… ì…ë ¥ ë°ì´í„°: {new_row}")
            
        except Exception as e:
            print(f"   âŒ ë°ì´í„° ì „ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
            import traceback
            traceback.print_exc()
            return False
        
        # êµ¬ê¸€ì‹œíŠ¸ì— í–‰ ì¶”ê°€ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
        max_retries = 3
        for attempt in range(max_retries):
            try:
                print(f"   ğŸ“ êµ¬ê¸€ì‹œíŠ¸ì— í–‰ ì¶”ê°€ ì‹œë„ {attempt + 1}/{max_retries}...")
                
                # append_row ì‹œë„
                try:
                    result = sheet1.append_row(new_row)
                    print(f"   âœ… append_row ì„±ê³µ!")
                except Exception as append_error:
                    print(f"   âš ï¸ append_row ì‹¤íŒ¨: {append_error}")
                    # append_rowê°€ ì‹¤íŒ¨í•˜ë©´ insert_row ì‚¬ìš©
                    try:
                        print("   ğŸ”„ insert_row ì‹œë„...")
                        current_row_count = len(sheet1.get_all_values())
                        result = sheet1.insert_row(new_row, current_row_count + 1)
                        print(f"   âœ… insert_row ì„±ê³µ!")
                    except Exception as insert_error:
                        print(f"   âŒ insert_rowë„ ì‹¤íŒ¨: {insert_error}")
                        raise insert_error
                
                print(f"   âœ… êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ! (ì‹œë„ {attempt + 1}/{max_retries})")
                print(f"   ê²°ê³¼: {result}")
                
                # ì¶”ê°€ëœ í–‰ í™•ì¸
                try:
                    updated_data = sheet1.get_all_values()
                    print(f"   ğŸ“Š ì—…ë°ì´íŠ¸ í›„ ì´ í–‰ ìˆ˜: {len(updated_data)}")
                    if len(updated_data) > 0:
                        last_row = updated_data[-1]
                        print(f"   ğŸ“‹ ë§ˆì§€ë§‰ í–‰: {last_row}")
                        
                        # ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
                        if last_row[0] == str(email_id):
                            print(f"   âœ… ìƒˆë¡œ ì¶”ê°€ëœ í–‰ í™•ì¸ ì™„ë£Œ: ì´ë©”ì¼ ID {email_id}")
                        else:
                            print(f"   âš ï¸ ìƒˆë¡œ ì¶”ê°€ëœ í–‰ í™•ì¸ ì‹¤íŒ¨: ì˜ˆìƒ ID {email_id}, ì‹¤ì œ ID {last_row[0]}")
                            
                except Exception as e:
                    print(f"   âš ï¸ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨: {e}")
                
                return True
                
            except Exception as e:
                print(f"   âŒ êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}/{max_retries}): {e}")
                if attempt < max_retries - 1:
                    print(f"   ğŸ”„ ì¬ì‹œë„ ì¤‘... ({attempt + 2}/{max_retries})")
                    time.sleep(3)  # ì¬ì‹œë„ ì „ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
                else:
                    print(f"   âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼")
                    import traceback
                    traceback.print_exc()
                    return False
        
    except Exception as e:
        print(f"âŒ êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì „ì²´ ì˜¤ë¥˜: {e}")
        print(f"   ì‹œë„í•œ ë°ì´í„°: {new_row}")
        import traceback
        traceback.print_exc()
        return False

def extract_dashboard_stats(dashboard_url):
    """ëŒ€ì‹œë³´ë“œì—ì„œ í†µê³„ ì •ë³´ ì¶”ì¶œ"""
    try:
        print("ëŒ€ì‹œë³´ë“œ í†µê³„ ì •ë³´ ì¶”ì¶œ ì¤‘...")
        
        # ë©”ì¼ ì œëª© ì¶”ì¶œ (ì—¬ëŸ¬ XPATH íŒ¨í„´ ì‹œë„)
        subject = "ì œëª© ì—†ìŒ"
        subject_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[1]/div[2]/div/div[1]/div[2]/div[2]/div',
            '//h1',
            '//div[contains(@class, "title")]',
            '//div[contains(@class, "subject")]',
            '//div[contains(@class, "email-title")]',
            '//span[contains(@class, "title")]'
        ]
        
        for pattern in subject_patterns:
            try:
                subject_elem = driver.find_element(By.XPATH, pattern)
                subject = subject_elem.text.strip()
                if subject:
                    print(f"  âœ… ë©”ì¼ ì œëª©: {subject}")
                    break
            except:
                continue
        
        # ë°œì†¡ì¼ì ì¶”ì¶œ (ì—¬ëŸ¬ XPATH íŒ¨í„´ ì‹œë„)
        sent_date = ""
        date_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[1]/div[2]/div/div[2]/div[3]/div[2]',
            '//div[contains(text(), "ë°œì†¡")]//span',
            '//span[contains(text(), "ë°œì†¡")]',
            '//div[contains(@class, "date")]',
            '//span[contains(@class, "date")]',
            '//div[contains(text(), "2024")]',
            '//span[contains(text(), "2024")]',
            '//div[contains(text(), "2025")]',
            '//span[contains(text(), "2025")]',
            '//div[contains(text(), "ë°œì†¡ì¼")]',
            '//span[contains(text(), "ë°œì†¡ì¼")]',
            '//div[contains(text(), "ë³´ë‚¸ ë‚ ì§œ")]',
            '//span[contains(text(), "ë³´ë‚¸ ë‚ ì§œ")]'
        ]
        
        for pattern in date_patterns:
            try:
                date_elem = driver.find_element(By.XPATH, pattern)
                date_text = date_elem.text.strip()
                if date_text and any(char.isdigit() for char in date_text):
                    # ì›ë³¸ ë‚ ì§œ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë³€í™˜í•˜ì§€ ì•ŠìŒ)
                    sent_date = date_text
                    print(f"  âœ… ë°œì†¡ì¼ì (ì›ë³¸): {sent_date}")
                    break
                        
            except Exception as e:
                print(f"  âš ï¸ ë‚ ì§œ íŒ¨í„´ {pattern} ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
                continue
        
        # í†µê³„ ì •ë³´ ì¶”ì¶œì„ ìœ„í•œ ê³µí†µ íŒ¨í„´
        stats_data = {}
        
        # ë°œì†¡ì„±ê³µìˆ˜ ì¶”ì¶œ
        sent_success_count = "0"
        sent_success_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[1]/div[1]/span[2]',
            '//div[contains(text(), "ë°œì†¡ì„±ê³µ")]//span[2]',
            '//span[contains(text(), "ë°œì†¡ì„±ê³µ")]/following-sibling::span',
            '//div[contains(@class, "success")]//span[2]'
        ]
        
        for pattern in sent_success_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                sent_success_count = elem.text.strip()
                if sent_success_count and sent_success_count.replace(',', '').isdigit():
                    print(f"  âœ… ë°œì†¡ì„±ê³µìˆ˜: {sent_success_count}")
                    break
            except:
                continue
        
        # ë°œì†¡ì„±ê³µìœ¨ ì¶”ì¶œ
        sent_success_rate = "0%"
        sent_success_rate_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[1]/div[2]/span',
            '//div[contains(text(), "ë°œì†¡ì„±ê³µ")]//span[contains(text(), "%")]',
            '//span[contains(text(), "%")]'
        ]
        
        for pattern in sent_success_rate_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                sent_success_rate = elem.text.strip()
                if sent_success_rate and "%" in sent_success_rate:
                    print(f"  âœ… ë°œì†¡ì„±ê³µìœ¨: {sent_success_rate}")
                    break
            except:
                continue
        
        # ì˜¤í”ˆìˆ˜ ì¶”ì¶œ
        open_count = "0"
        open_count_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[2]/div[1]/span[2]',
            '//div[contains(text(), "ì˜¤í”ˆ")]//span[2]',
            '//span[contains(text(), "ì˜¤í”ˆ")]/following-sibling::span',
            '//div[contains(@class, "open")]//span[2]'
        ]
        
        for pattern in open_count_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                open_count = elem.text.strip()
                if open_count and open_count.replace(',', '').isdigit():
                    print(f"  âœ… ì˜¤í”ˆìˆ˜: {open_count}")
                    break
            except:
                continue
        
        # ì˜¤í”ˆìœ¨ ì¶”ì¶œ
        open_rate = "0%"
        open_rate_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[2]/div[2]/span',
            '//div[contains(text(), "ì˜¤í”ˆ")]//span[contains(text(), "%")]'
        ]
        
        for pattern in open_rate_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                open_rate = elem.text.strip()
                if open_rate and "%" in open_rate:
                    print(f"  âœ… ì˜¤í”ˆìœ¨: {open_rate}")
                    break
            except:
                continue
        
        # í´ë¦­ìˆ˜ ì¶”ì¶œ
        click_count = "0"
        click_count_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[3]/div[1]/span[2]',
            '//div[contains(text(), "í´ë¦­")]//span[2]',
            '//span[contains(text(), "í´ë¦­")]/following-sibling::span',
            '//div[contains(@class, "click")]//span[2]'
        ]
        
        for pattern in click_count_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                click_count = elem.text.strip()
                if click_count and click_count.replace(',', '').isdigit():
                    print(f"  âœ… í´ë¦­ìˆ˜: {click_count}")
                    break
            except:
                continue
        
        # í´ë¦­ë¥  ì¶”ì¶œ
        click_rate = "0%"
        click_rate_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[3]/div[2]/span',
            '//div[contains(text(), "í´ë¦­")]//span[contains(text(), "%")]'
        ]
        
        for pattern in click_rate_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                click_rate = elem.text.strip()
                if click_rate and "%" in click_rate:
                    print(f"  âœ… í´ë¦­ë¥ : {click_rate}")
                    break
            except:
                continue
        
        # ìˆ˜ì‹ ê±°ë¶€ìˆ˜ ì¶”ì¶œ
        unsub_count = "0"
        unsub_count_patterns = [
            '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[2]/div[2]/div[4]/div[1]/span[2]',
            '//div[contains(text(), "ìˆ˜ì‹ ê±°ë¶€")]//span[2]',
            '//span[contains(text(), "ìˆ˜ì‹ ê±°ë¶€")]/following-sibling::span',
            '//div[contains(@class, "unsubscribe")]//span[2]'
        ]
        
        for pattern in unsub_count_patterns:
            try:
                elem = driver.find_element(By.XPATH, pattern)
                unsub_count = elem.text.strip()
                if unsub_count and unsub_count.replace(',', '').isdigit():
                    print(f"  âœ… ìˆ˜ì‹ ê±°ë¶€ìˆ˜: {unsub_count}")
                    break
            except:
                continue
        
        stats = {
            'ë©”ì¼ì œëª©': subject,
            'ë°œì†¡ì¼ì': sent_date,
            'ë°œì†¡ì„±ê³µìˆ˜': sent_success_count,
            'ë°œì†¡ì„±ê³µìœ¨': sent_success_rate,
            'ì˜¤í”ˆìˆ˜': open_count,
            'ì˜¤í”ˆìœ¨': open_rate,
            'í´ë¦­ìˆ˜': click_count,
            'í´ë¦­ë¥ ': click_rate,
            'ìˆ˜ì‹ ê±°ë¶€ìˆ˜': unsub_count
        }
        
        print(f"  ğŸ“‹ ì¶”ì¶œ ì™„ë£Œëœ í†µê³„: {stats}")
        return stats
        
    except Exception as e:
        print(f"  âŒ ëŒ€ì‹œë³´ë“œ í†µê³„ ì¶”ì¶œ ì „ì²´ ì‹¤íŒ¨: {e}")
        import traceback
        traceback.print_exc()
        return {}

def collect_all_sent_emails():
    """ë°œì†¡ì™„ë£Œëœ ëª¨ë“  ì´ë©”ì¼ì˜ í†µê³„ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì—¬ êµ¬ê¸€ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸"""
    page = 1
    max_pages = 4  # ìµœëŒ€ 4í˜ì´ì§€ê¹Œì§€ë§Œ ì²˜ë¦¬
    existing_ids = get_existing_email_ids()
    updated_count = 0
    failed_count = 0
    
    print(f"\nğŸš€ ì´ë©”ì¼ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘!")
    print(f"ğŸ“… ëª¨ë“  ë°œì†¡ì™„ë£Œ ë©”ì¼ ìˆ˜ì§‘")
    print(f"ğŸ“Š ê¸°ì¡´ì— ê¸°ë¡ëœ ì´ë©”ì¼ ID ìˆ˜: {len(existing_ids)}")
    print(f"ğŸ“„ êµ¬ê¸€ì‹œíŠ¸ URL: {sheet_url}")
    print(f"ğŸ“„ ìµœëŒ€ ì²˜ë¦¬ í˜ì´ì§€: {max_pages}í˜ì´ì§€")
    print("=" * 80)
    
    while page <= max_pages:
        print(f"\nğŸ“„ {page}í˜ì´ì§€ ì²˜ë¦¬ ì¤‘... (ìµœëŒ€ {max_pages}í˜ì´ì§€)")
        url = f'https://stibee.com/emails/{page}?emailStatus=3'
        
        try:
            driver.get(url)
            time.sleep(8)  # í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
            
            # í˜„ì¬ URL í™•ì¸
            current_url = driver.current_url
            print(f"  ğŸ“ í˜„ì¬ URL: {current_url}")
            
            # ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if 'login' in current_url:
                print(f"  âŒ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ë¡œê·¸ì¸ ì‹œë„...")
                if not stibee_login():
                    print("âŒ ì¬ë¡œê·¸ì¸ ì‹¤íŒ¨. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                    break
                # ì¬ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ í˜„ì¬ í˜ì´ì§€ë¡œ ì´ë™
                driver.get(url)
                time.sleep(5)
            
            # í˜ì´ì§€ ì†ŒìŠ¤ í™•ì¸
            page_source = driver.page_source
            if 'ì´ë©”ì¼' in page_source or 'email' in page_source.lower():
                print(f"  âœ… í˜ì´ì§€ì— ì´ë©”ì¼ ê´€ë ¨ ë‚´ìš© ë°œê²¬")
            else:
                print(f"  âš ï¸ í˜ì´ì§€ì— ì´ë©”ì¼ ê´€ë ¨ ë‚´ìš©ì´ ì—†ìŒ")
            
            # ì´ë©”ì¼ ìš”ì†Œ ì°¾ê¸° - ê°œì„ ëœ ë°©ë²•
            print(f"  ğŸ” ì´ë©”ì¼ ìš”ì†Œ ê²€ìƒ‰ ì¤‘...")
            
            # ë°©ë²• 1: í˜ì´ì§€ ì†ŒìŠ¤ì—ì„œ ì§ì ‘ ì´ë©”ì¼ ID ì¶”ì¶œ (ê°€ì¥ ì•ˆì •ì )
            print(f"    ğŸ” í˜ì´ì§€ ì†ŒìŠ¤ì—ì„œ ì´ë©”ì¼ ID ì¶”ì¶œ ì¤‘...")
            
            # ë‹¤ì–‘í•œ ì´ë©”ì¼ ë§í¬ íŒ¨í„´ ì‹œë„
            email_patterns = [
                r'https://stibee\.com/email/(\d+)/dashboard',
                r'https://stibee\.com/email/(\d+)/logs',
                r'https://stibee\.com/email/(\d+)/stats',
                r'https://stibee\.com/email/(\d+)',
                r'/email/(\d+)/dashboard',
                r'/email/(\d+)/logs',
                r'/email/(\d+)/stats',
                r'/email/(\d+)'
            ]
            
            all_email_ids = []
            for pattern in email_patterns:
                matches = re.findall(pattern, page_source)
                if matches:
                    print(f"      ğŸ¯ íŒ¨í„´ '{pattern}'ìœ¼ë¡œ {len(matches)}ê°œ ì´ë©”ì¼ ID ë°œê²¬")
                    all_email_ids.extend(matches)
            
            # ì¤‘ë³µ ì œê±° ë° ì •ë ¬
            unique_email_ids = list(set(all_email_ids))
            unique_email_ids.sort(key=int)  # ìˆ«ì ìˆœìœ¼ë¡œ ì •ë ¬
            
            if unique_email_ids:
                print(f"    ğŸ¯ ì´ {len(unique_email_ids)}ê°œì˜ ê³ ìœ í•œ ì´ë©”ì¼ ID ë°œê²¬!")
                print(f"    ğŸ“‹ ì´ë©”ì¼ ID ëª©ë¡: {unique_email_ids[:10]}...")  # ì²˜ìŒ 10ê°œë§Œ í‘œì‹œ
                
                # ê° ì´ë©”ì¼ IDë¡œ ëŒ€ì‹œë³´ë“œ ì ‘ê·¼
                processed_count = 0
                for email_index, email_id in enumerate(unique_email_ids):  # ëª¨ë“  ì´ë©”ì¼ ì²˜ë¦¬
                    try:
                        print(f"\n    ğŸ“§ {email_index+1}ë²ˆì§¸ ì´ë©”ì¼ ì²˜ë¦¬ ì¤‘... (ID: {email_id})")
                        
                        # ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë©”ì¼ì¸ì§€ í™•ì¸
                        if email_id in existing_ids:
                            print(f"      â­ï¸ ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë©”ì¼ ID: {email_id}, ê±´ë„ˆë›°ê¸°")
                            continue
                        
                        # ëŒ€ì‹œë³´ë“œ URL ì§ì ‘ êµ¬ì„±
                        dashboard_url = f'https://stibee.com/email/{email_id}/dashboard'
                        print(f"      ğŸ”— ëŒ€ì‹œë³´ë“œ URL: {dashboard_url}")
                        
                        # ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ë¡œ ì§ì ‘ ì´ë™
                        print(f"      ğŸ”„ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...")
                        driver.get(dashboard_url)
                        time.sleep(5)
                        
                        # ëŒ€ì‹œë³´ë“œ ë¡œë”© í™•ì¸
                        try:
                            WebDriverWait(driver, 15).until(
                                EC.presence_of_element_located((By.XPATH, '//h1 | //div[contains(@class, "title")]'))
                            )
                            print(f"      âœ… ëŒ€ì‹œë³´ë“œ ë¡œë”© ì™„ë£Œ")
                        except:
                            print(f"      âš ï¸ ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹œê°„ ì´ˆê³¼, ê³„ì† ì§„í–‰")
                        
                        # ë°œì†¡ì¼ì í™•ì¸ (30ì¼ ì´ë‚´ì¸ì§€ ì²´í¬)
                        try:
                            # ë°œì†¡ì¼ì ì¶”ì¶œ ì‹œë„
                            date_patterns = [
                                '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[1]/div[2]/div/div[2]/div[3]/div[2]',
                                '//div[contains(text(), "ë°œì†¡")]//span',
                                '//span[contains(text(), "ë°œì†¡")]',
                                '//div[contains(@class, "date")]',
                                '//span[contains(@class, "date")]',
                                '//div[contains(text(), "2024")]',
                                '//span[contains(text(), "2024")]',
                                '//div[contains(text(), "2025")]',
                                '//span[contains(text(), "2025")]',
                                '//div[contains(text(), "ë°œì†¡ì¼")]',
                                '//span[contains(text(), "ë°œì†¡ì¼")]',
                                '//div[contains(text(), "ë³´ë‚¸ ë‚ ì§œ")]',
                                '//span[contains(text(), "ë³´ë‚¸ ë‚ ì§œ")]'
                            ]
                            
                            sent_date = None
                            for date_pattern in date_patterns:
                                try:
                                    date_elem = driver.find_element(By.XPATH, date_pattern)
                                    date_text = date_elem.text.strip()
                                    if date_text and any(char.isdigit() for char in date_text):
                                        print(f"      ğŸ” ë‚ ì§œ í…ìŠ¤íŠ¸ ë°œê²¬: {date_text}")
                                        
                                        # ì›ë³¸ ë‚ ì§œ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë³€í™˜í•˜ì§€ ì•ŠìŒ)
                                        sent_date_text = date_text
                                        print(f"      ğŸ“… ë°œì†¡ì¼ì (ì›ë³¸): {sent_date_text}")
                                        
                                        # 30ì¼ ì´ë‚´ ë°œì†¡ ì—¬ë¶€ í™•ì¸ì„ ìœ„í•´ ë‚ ì§œ íŒŒì‹±
                                        # í•œêµ­ì–´ í˜•ì‹: 2025. 8. 5. ì˜¤ì „ 9:00
                                        kr_match = re.search(r'(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})', date_text)
                                        if kr_match:
                                            year, month, day = map(int, kr_match.groups())
                                            sent_date = datetime(year, month, day)
                                            print(f"      ğŸ“… ë°œì†¡ì¼ì (íŒŒì‹±): {sent_date.strftime('%Y-%m-%d')}")
                                        else:
                                            # ë‹¤ë¥¸ í˜•ì‹ì´ë©´ í˜„ì¬ ë‚ ì§œë¡œ ê°€ì •í•˜ê³  ê³„ì† ì§„í–‰
                                            sent_date = None
                                            print(f"      âš ï¸ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨, ê³„ì† ì§„í–‰")
                                        
                                        break
                                            
                                except Exception as e:
                                    print(f"      âš ï¸ ë‚ ì§œ íŒ¨í„´ {pattern} ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
                                    continue
                            
                            # ë°œì†¡ì¼ì í™•ì¸ (ëª¨ë“  ë©”ì¼ ì²˜ë¦¬)
                            if sent_date:
                                print(f"      ğŸ“… ë°œì†¡ì¼ì: {sent_date.strftime('%Y-%m-%d')}")
                            elif not sent_date:
                                print(f"      âš ï¸ ë°œì†¡ì¼ìë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŒ, ê³„ì† ì§„í–‰")
                            
                        except Exception as e:
                            print(f"      âš ï¸ ë°œì†¡ì¼ì í™•ì¸ ì‹¤íŒ¨: {e}, ê³„ì† ì§„í–‰")
                        
                        # í†µê³„ ì •ë³´ ì¶”ì¶œ (ë°œì†¡ì¼ì í¬í•¨)
                        stats = extract_dashboard_stats(dashboard_url)
                        # ë°œì†¡ì¼ìë¥¼ statsì— ì¶”ê°€
                        if 'sent_date_text' in locals():
                            stats['ë°œì†¡ì¼ì'] = sent_date_text
                        
                        if stats and stats.get('ë©”ì¼ì œëª©'):
                            # êµ¬ê¸€ì‹œíŠ¸ì— ë°ì´í„° ì¶”ê°€
                            if update_google_sheet_sheet1_append(email_id, stats):
                                existing_ids.add(email_id)
                                updated_count += 1
                                processed_count += 1
                                print(f"      ğŸ‰ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨!")
                            else:
                                failed_count += 1
                                print(f"      âŒ êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨")
                        else:
                            print(f"      âŒ í†µê³„ ì •ë³´ ì¶”ì¶œ ì‹¤íŒ¨")
                            failed_count += 1
                        
                        # ë©”ì¼ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ë³µê·€
                        print(f"      ğŸ”™ ë©”ì¼ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ë³µê·€ ì¤‘...")
                        driver.get(url)
                        time.sleep(3)
                        
                        # í•œ í˜ì´ì§€ì˜ ëª¨ë“  ë©”ì¼ì„ ì²˜ë¦¬í•œ í›„ ë‹¤ìŒ í˜ì´ì§€ë¡œ (30ì¼ ì´ë‚´ ë©”ì¼ ìˆ˜ì— ê´€ê³„ì—†ì´)
                        # í˜„ì¬ í˜ì´ì§€ì˜ ëª¨ë“  ë©”ì¼ì„ ì²˜ë¦¬í–ˆëŠ”ì§€ í™•ì¸
                        if email_index >= len(all_email_ids) - 1:  # ë§ˆì§€ë§‰ ë©”ì¼ê¹Œì§€ ì²˜ë¦¬ ì™„ë£Œ
                            print(f"      âœ… í˜„ì¬ í˜ì´ì§€ì˜ ëª¨ë“  ë©”ì¼ ì²˜ë¦¬ ì™„ë£Œ, ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™")
                            break
                            
                    except Exception as e:
                        print(f"      âŒ ì´ë©”ì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
                        failed_count += 1
                        # ë©”ì¼ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ë³µê·€
                        try:
                            driver.get(url)
                            time.sleep(3)
                        except:
                            pass
                        continue
                
                # ì´ë©”ì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒ í˜ì´ì§€ë¡œ
                if processed_count > 0:
                    page += 1
                    print(f"  ğŸ“„ ë‹¤ìŒ í˜ì´ì§€({page})ë¡œ ì´ë™...")
                    print(f"  ğŸ“Š í˜„ì¬ê¹Œì§€ ì—…ë°ì´íŠ¸ëœ ì´ë©”ì¼: {updated_count}ê°œ")
                    print(f"  ğŸ“Š í˜„ì¬ê¹Œì§€ ì‹¤íŒ¨: {failed_count}ê°œ")
                    continue
                else:
                    print(f"  âš ï¸ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” 30ì¼ ì´ë‚´ ë©”ì¼ì´ ì—†ìŒ")
                    # ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if page < max_pages:
                        next_page_url = f'https://stibee.com/emails/{page + 1}?emailStatus=3'
                        print(f"  ğŸ” ë‹¤ìŒ í˜ì´ì§€ í™•ì¸: {next_page_url}")
                        
                        # ë‹¤ìŒ í˜ì´ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                        try:
                            driver.get(next_page_url)
                            time.sleep(5)
                            next_page_source = driver.page_source
                            
                            if 'ì´ë©”ì¼' in next_page_source or 'email' in next_page_source.lower():
                                print(f"  âœ… ë‹¤ìŒ í˜ì´ì§€({page + 1})ì— ì´ë©”ì¼ì´ ìˆìŒ, ê³„ì† ì§„í–‰")
                                page += 1
                                continue
                            else:
                                print(f"  âŒ ë‹¤ìŒ í˜ì´ì§€({page + 1})ì— ì´ë©”ì¼ì´ ì—†ìŒ, ì¢…ë£Œ")
                                break
                        except Exception as e:
                            print(f"  âŒ ë‹¤ìŒ í˜ì´ì§€ í™•ì¸ ì‹¤íŒ¨: {e}")
                            break
                    else:
                        print(f"  ğŸ“„ ìµœëŒ€ í˜ì´ì§€({max_pages})ì— ë„ë‹¬, ì¢…ë£Œ")
                        break
                    
            else:
                print(f"  âŒ í˜ì´ì§€ì—ì„œ ì´ë©”ì¼ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ")
                # í˜ì´ì§€ ì†ŒìŠ¤ ì €ì¥í•˜ì—¬ ë””ë²„ê¹…
                with open(f'page_{page}_source.html', 'w', encoding='utf-8') as f:
                    f.write(page_source)
                print(f"  ğŸ“„ í˜ì´ì§€ {page} ì†ŒìŠ¤ë¥¼ page_{page}_source.htmlë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.")
                
                # ë‹¤ìŒ í˜ì´ì§€ ì‹œë„
                if page < max_pages:
                    page += 1
                    print(f"  ğŸ“„ ë‹¤ìŒ í˜ì´ì§€({page})ë¡œ ì´ë™ ì‹œë„...")
                    continue
                else:
                    print(f"  ğŸ“„ ìµœëŒ€ í˜ì´ì§€({max_pages})ì— ë„ë‹¬, ì¢…ë£Œ")
                    break
                
        except Exception as e:
            print(f"  âŒ {page}í˜ì´ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
            if page < max_pages:
                page += 1
                print(f"  ğŸ“„ ë‹¤ìŒ í˜ì´ì§€({page})ë¡œ ì´ë™ ì‹œë„...")
                continue
            else:
                print(f"  ğŸ“„ ìµœëŒ€ í˜ì´ì§€({max_pages})ì— ë„ë‹¬, ì¢…ë£Œ")
                break
    
    print(f"\n" + "=" * 80)
    print(f"ğŸ‰ ì´ë©”ì¼ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!")
    print(f"ğŸ“… ë°œì†¡ì¼ì ê¸°ì¤€: {cutoff_date.strftime('%Y-%m-%d')} ì´í›„")
    print(f"ğŸ“Š ì´ ì—…ë°ì´íŠ¸ëœ ì´ë©”ì¼: {updated_count}ê°œ")
    print(f"âŒ ì´ ì‹¤íŒ¨: {failed_count}ê°œ")
    print(f"ğŸ“„ ì²˜ë¦¬ëœ í˜ì´ì§€: {page-1}í˜ì´ì§€ (ìµœëŒ€ {max_pages}í˜ì´ì§€)")
    print("=" * 80)

def process_emails_and_update_sheets():
    """ë©”ì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©° ê° ë©”ì¼ì˜ ëŒ€ì‹œë³´ë“œ ë§í¬ë¥¼ í´ë¦­í•´ í†µê³„ ì •ë³´ë¥¼ êµ¬ê¸€ì‹œíŠ¸ì— ë°”ë¡œ ì—…ë°ì´íŠ¸"""
    emails = get_recent_emails_from_sent_page()
    if not emails:
        print("ë©”ì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        return

    # êµ¬ê¸€ì‹œíŠ¸ ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    existing_ids = get_existing_email_ids()

    for i, email in enumerate(emails, 1):
        email_id = email['id']
        subject = email['subject']
        sent_date = email['sent_date']
        dashboard_elem = email['dashboard_elem']

        print(f"\n=== {i}/{len(emails)} : {subject} ({sent_date}) ===")

        # 1. ëŒ€ì‹œë³´ë“œ ë§í¬ í´ë¦­
        try:
            dashboard_elem.click()
            # ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ì˜ˆ: ë©”ì¼ì œëª© ìš”ì†Œ)
            WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[1]/div[2]/div/div[1]/div[2]/div[2]/div'))
            )
            time.sleep(1)
        except Exception as e:
            print(f"ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ì§„ì… ì‹¤íŒ¨: {e}")
            continue

        # ëŒ€ì‹œë³´ë“œ ì§„ì… í›„
        try:
            # ë°œì†¡ì¼ì ì¶”ì¶œ
            date_elem = driver.find_element(By.XPATH, '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[1]/div[2]/div/div[2]/div[3]/div[2]')
            sent_date_str = date_elem.text.strip()  # ì˜ˆ: '2024-07-10'
            sent_date = datetime.strptime(sent_date_str[:10], "%Y-%m-%d")
            if sent_date < datetime.now() - timedelta(days=30):
                print(f"ë°œì†¡ì¼ì {sent_date_str} (30ì¼ ì´ˆê³¼), ê±´ë„ˆëœ€")
                # ë©”ì¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë³µê·€
                driver.back()
                continue
        except Exception as e:
            print(f"ë°œì†¡ì¼ì ì¶”ì¶œ ì‹¤íŒ¨: {e}")
            driver.back()
            continue

        # 30ì¼ ì´ë‚´ë¼ë©´ ë°ì´í„° ì¶”ì¶œ ë° êµ¬ê¸€ì‹œíŠ¸ ì—…ë°ì´íŠ¸
        # 2. ë©”ì¼ ë°œì†¡ ì„±ê³¼ ì‹œíŠ¸ (ì´ë©”ì¼ID ì¤‘ë³µ ì²´í¬)
        if email_id not in existing_ids:
            stats = extract_dashboard_stats(driver.current_url)
            update_google_sheet_sheet1_append(email_id, stats)
            existing_ids.add(email_id)
        else:
            print(f"ì´ë¯¸ ê¸°ë¡ëœ ì´ë©”ì¼ID: {email_id}, ê±´ë„ˆëœ€")

        # ë©”ì¼ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ë‹¤ì‹œ ëŒì•„ê°€ê¸°
        driver.back()
        # ë©”ì¼ ë¦¬ìŠ¤íŠ¸ê°€ ë‹¤ì‹œ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        try:
            WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, f'//*[@id="root"]/div/div[1]/div/section/main/div/div[{i+2}]/div/div[1]/div[2]'))
            )
            time.sleep(1)
        except Exception as e:
            print(f"ë©”ì¼ ë¦¬ìŠ¤íŠ¸ ë³µê·€ ì‹¤íŒ¨: {e}")
            break
        time.sleep(2)
    print(f'\nğŸ‰ 30ì¼ ì´ë‚´ ë©”ì¼ ì„±ê³¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ!')

# 1. í•¨ìˆ˜ ì •ì˜ (ë°˜ë“œì‹œ main ì‹¤í–‰ë¶€ë³´ë‹¤ ìœ„ì— ìœ„ì¹˜)
def get_recent_emails_from_sent_page():
    page = 1
    while True:
        url = f'https://stibee.com/emails/{page}?emailStatus=3'
        driver.get(url)
        try:
            WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, '//*[@id="root"]/div/div[1]/div/section/main/div/div[2]/div/div[1]/div[2]'))
            )
        except Exception as e:
            print(f"{page}í˜ì´ì§€ ë¡œë”© ì‹¤íŒ¨: {e}")
            break

        found_recent = False
        for N in range(2, 12):
            try:
                base_xpath = f'//*[@id="root"]/div/div[1]/div/section/main/div/div[{N}]/div/div[1]/div[2]'
                date_elem = driver.find_element(By.XPATH, base_xpath + '/div[2]/em')
                sent_date_str = date_elem.text.strip()
                date_match = re.search(r'(\d{4})[.\- ]\s*(\d{1,2})[.\- ]\s*(\d{1,2})', sent_date_str)
                if date_match:
                    year, month, day = date_match.groups()
                    sent_date = datetime(int(year), int(month), int(day))
                else:
                    print(f"{page}í˜ì´ì§€ {N}ë²ˆì§¸ ë©”ì¼ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨: {sent_date_str}")
                    continue
                if sent_date < datetime.now() - timedelta(days=30):
                    continue
                found_recent = True

                dashboard_a_elem = driver.find_element(By.XPATH, base_xpath + '/div[1]/a')
                dashboard_url = dashboard_a_elem.get_attribute('href')
                subject = dashboard_a_elem.text.strip()
                email_id_match = re.search(r'/email/(\d+)/dashboard', dashboard_url)
                email_id = email_id_match.group(1) if email_id_match else None

                for attempt in range(2):
                    try:
                        driver.get(dashboard_url)
                        WebDriverWait(driver, 20).until(
                            EC.presence_of_element_located((By.XPATH, '//*[@id="root"]/div/div[1]/div/section/main/div/div/div[4]/div[1]/div[2]/div/div[1]/div[2]/div[2]/div'))
                        )
                        time.sleep(2)
                        stats = extract_dashboard_stats(dashboard_url)
                        print(f"ì¶”ì¶œëœ stats: {stats}")
                        # 2. êµ¬ê¸€ì‹œíŠ¸ ì…ë ¥
                        update_google_sheet_sheet1_append(email_id, stats)
                        # 3. ìˆ˜ì‹ ê±°ë¶€/ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ë„ ë™ì¼í•˜ê²Œ ë°˜ë³µ
                        # ...
                        break
                    except Exception as e:
                        print(f"ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìˆ˜ì§‘ ì¬ì‹œë„({attempt+1}/2): {e}")
                        time.sleep(3)
                        if attempt == 1:
                            print(f"{page}í˜ì´ì§€ {N}ë²ˆì§¸ ë©”ì¼ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨")
                driver.back()
            except Exception as e:
                print(f"{page}í˜ì´ì§€ {N}ë²ˆì§¸ ë©”ì¼ ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
                continue
        if not found_recent:
            print(f"{page}í˜ì´ì§€ì— 30ì¼ ì´ë‚´ ë©”ì¼ ì—†ìŒ, ì „ì²´ ìˆ˜ì§‘ ì¢…ë£Œ")
            break
        page += 1

def test_google_sheet_access():
    """êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ ë° ì“°ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸"""
    try:
        print("ğŸ” êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì‹œì‘...")
        
        # 1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
        print("   ğŸ“„ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸° ì‹œë„...")
        spreadsheet = client.open_by_url(sheet_url)
        print(f"   âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸° ì„±ê³µ: {spreadsheet.title}")
        
        # 2. ì›Œí¬ì‹œíŠ¸ ì ‘ê·¼
        print("   ğŸ“‹ 'ë©”ì¼ ë°œì†¡ ì„±ê³¼' ì›Œí¬ì‹œíŠ¸ ì ‘ê·¼ ì‹œë„...")
        worksheet = spreadsheet.worksheet('ë©”ì¼ ë°œì†¡ ì„±ê³¼')
        print(f"   âœ… ì›Œí¬ì‹œíŠ¸ ì ‘ê·¼ ì„±ê³µ: {worksheet.title}")
        
        # 3. ì›Œí¬ì‹œíŠ¸ ì •ë³´ í™•ì¸
        print(f"   ğŸ“Š ì›Œí¬ì‹œíŠ¸ í¬ê¸°: {worksheet.row_count}í–‰ x {worksheet.col_count}ì—´")
        
        # 4. ê¸°ì¡´ ë°ì´í„° ì½ê¸°
        print("   ğŸ“– ê¸°ì¡´ ë°ì´í„° ì½ê¸° ì‹œë„...")
        existing_data = worksheet.get_all_values()
        print(f"   âœ… ê¸°ì¡´ ë°ì´í„° ì½ê¸° ì„±ê³µ: {len(existing_data)}í–‰")
        
        if len(existing_data) > 0:
            print(f"   ğŸ“‹ í—¤ë”: {existing_data[0]}")
            if len(existing_data) > 1:
                print(f"   ğŸ“‹ ì²« ë²ˆì§¸ ë°ì´í„° í–‰: {existing_data[1]}")
        
        # 5. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì“°ê¸° (ì„ì‹œ)
        print("   âœï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì“°ê¸° ì‹œë„...")
        test_row = ['TEST_EMAIL_ID', '2024-08-31', 'í…ŒìŠ¤íŠ¸ ë©”ì¼', '100', '100%', '50', '50%', '10', '10%', '0']
        
        # append_row ì‹œë„
        try:
            result = worksheet.append_row(test_row)
            print(f"   âœ… append_row ì„±ê³µ: {result}")
            
            # ì¶”ê°€ëœ í–‰ í™•ì¸
            updated_data = worksheet.get_all_values()
            print(f"   ğŸ“Š ì—…ë°ì´íŠ¸ í›„ ì´ í–‰ ìˆ˜: {len(updated_data)}")
            
            if len(updated_data) > 0:
                last_row = updated_data[-1]
                print(f"   ğŸ“‹ ë§ˆì§€ë§‰ í–‰: {last_row}")
                
                # í…ŒìŠ¤íŠ¸ í–‰ì´ ì˜¬ë°”ë¥´ê²Œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if last_row[0] == 'TEST_EMAIL_ID':
                    print("   âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ê²Œ ì¶”ê°€ë¨")
                else:
                    print(f"   âš ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: ì˜ˆìƒ ID TEST_EMAIL_ID, ì‹¤ì œ ID {last_row[0]}")
            
            # 6. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
            print("   ğŸ—‘ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì‹œë„...")
            worksheet.delete_rows(len(updated_data))
            print("   âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì„±ê³µ")
            
            # ì‚­ì œ í™•ì¸
            final_data = worksheet.get_all_values()
            print(f"   ğŸ“Š ìµœì¢… í–‰ ìˆ˜: {len(final_data)} (í…ŒìŠ¤íŠ¸ ë°ì´í„° ì œê±°ë¨)")
            
        except Exception as e:
            print(f"   âŒ append_row ì‹¤íŒ¨: {e}")
            
            # insert_row ì‹œë„
            try:
                print("   ğŸ”„ insert_row ì‹œë„...")
                current_row_count = len(worksheet.get_all_values())
                result = worksheet.insert_row(test_row, current_row_count + 1)
                print(f"   âœ… insert_row ì„±ê³µ: {result}")
                
                # í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
                updated_data = worksheet.get_all_values()
                worksheet.delete_rows(len(updated_data))
                print("   âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì„±ê³µ")
                
            except Exception as insert_error:
                print(f"   âŒ insert_rowë„ ì‹¤íŒ¨: {insert_error}")
                return False
        
        print("   ğŸ‰ êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
        return True
        
    except Exception as e:
        print(f"âŒ êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
        import traceback
        traceback.print_exc()
        return False

# 2. main ì‹¤í–‰ë¶€
if __name__ == '__main__':
    try:
        print("ğŸš€ ìŠ¤í‹°ë¹„ ë©”ì¼ ë°œì†¡ ê²°ê³¼ ìˆ˜ì§‘ í”„ë¡œê·¸ë¨ ì‹œì‘")
        print("=" * 80)
        
        # 1. êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
        print("ğŸ” 1ë‹¨ê³„: êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸")
        if not test_google_sheet_access():
            print("âŒ êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            exit(1)
        print("âœ… êµ¬ê¸€ì‹œíŠ¸ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ì„±ê³µ!")
        print()
        
        # 2. ìŠ¤í‹°ë¹„ ë¡œê·¸ì¸
        print("ğŸ” 2ë‹¨ê³„: ìŠ¤í‹°ë¹„ ë¡œê·¸ì¸")
        if not stibee_login():
            print("âŒ ìŠ¤í‹°ë¹„ ë¡œê·¸ì¸ ì‹¤íŒ¨. í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            exit(1)
        print("âœ… ìŠ¤í‹°ë¹„ ë¡œê·¸ì¸ ì„±ê³µ!")
        print()
        
        # 3. ë©”ì¼ ë°œì†¡ ê²°ê³¼ ìˆ˜ì§‘
        print("ğŸ“§ 3ë‹¨ê³„: ë©”ì¼ ë°œì†¡ ê²°ê³¼ ìˆ˜ì§‘")
        collect_all_sent_emails()
        print()
        
        print("ğŸ‰ ë©”ì¼ ë°œì†¡ ê²°ê³¼ ìˆ˜ì§‘ ì™„ë£Œ!")
        print("ğŸ“Š ìˆ˜ì§‘ëœ ë°ì´í„°: ë©”ì¼ì œëª©, ë°œì†¡ì¼ì, ë°œì†¡ì„±ê³µìˆ˜, ë°œì†¡ì„±ê³µìœ¨, ì˜¤í”ˆìˆ˜, ì˜¤í”ˆìœ¨, í´ë¦­ìˆ˜, í´ë¦­ë¥ , ìˆ˜ì‹ ê±°ë¶€ìˆ˜")
        print("ğŸ“„ ì €ì¥ ìœ„ì¹˜: êµ¬ê¸€ì‹œíŠ¸ 'ë©”ì¼ ë°œì†¡ ì„±ê³¼' ì‹œíŠ¸")
        
    except KeyboardInterrupt:
        print("\nâš ï¸ ì‚¬ìš©ìì— ì˜í•´ í”„ë¡œê·¸ë¨ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"\nâŒ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
    finally:
        print("\nğŸ”š í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì¤‘...")
        try:
            if 'driver' in locals():
                driver.quit()
                print("âœ… ì›¹ë“œë¼ì´ë²„ê°€ ì•ˆì „í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        except:
            pass
        print("âœ… í”„ë¡œê·¸ë¨ì´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")

def update_unsubscribes_and_failures_only(email_ids):
    # ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘)
    print("ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.")
    pass

def update_unsubscribe_list_from_sent_sheet():
    # ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘)
    print("ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.")
    pass

def update_fail_list_from_sent_sheet():
    # ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘)
    print("ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.")
    pass

def open_unsubscribe_pages_from_sheet():
    # ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘)
    print("ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë©”ì¼ ë°œì†¡ ê²°ê³¼ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.")
    pass
